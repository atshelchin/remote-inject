name: Deploy Remote Inject Server

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      rollback_to:
        description: 'Release name to rollback to (leave empty for normal deploy)'
        required: false
        default: ''

# Prevent concurrent deployments
concurrency:
  group: deploy-remote-inject
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: 'Remote Inject Server'
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_KEY:  ${{ secrets.SSH_KEY }}
      EXE_NAME: 'remote-inject'
      BASE_PATH: '/opt/remote-inject'
      SERVICE_NAME: 'remote-inject.service'
      SOURCE_PATH: "packages/server/dist/remote-inject"
      ENV_CONTENT: ${{ secrets.ENV_FILE }}
      CONFIG_DIR: ${{ secrets.CONFIG_DIR || '' }}
      KEEP_RELEASES: 5
    steps:
      - name: Checkout code
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: actions/checkout@v4

      - name: Setup Bun
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.8

      - name: Cache bun dependencies
        if: ${{ github.event.inputs.rollback_to == '' }}
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install & Build
        if: ${{ github.event.inputs.rollback_to == '' }}
        run: |
          bun install
          cd packages/server && bun run build:exe

      - name: Verify build output
        if: ${{ github.event.inputs.rollback_to == '' }}
        run: |
          if [ ! -f "${{ env.SOURCE_PATH }}" ]; then
            echo "::error::Build failed: executable not found at ${{ env.SOURCE_PATH }}"
            exit 1
          fi
          echo "Build successful"
          echo "  Size: $(du -h ${{ env.SOURCE_PATH }} | cut -f1)"
          echo "  SHA256: $(sha256sum ${{ env.SOURCE_PATH }} | cut -d' ' -f1)"

      - name: Prepare Release Info
        id: release_info
        run: |
          if [ -n "${{ github.event.inputs.rollback_to }}" ]; then
            echo "release_name=${{ github.event.inputs.rollback_to }}" >> $GITHUB_OUTPUT
            echo "is_rollback=true" >> $GITHUB_OUTPUT
            echo "Rollback to: ${{ github.event.inputs.rollback_to }}"
          else
            RELEASE_NAME="$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)"
            echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "is_rollback=false" >> $GITHUB_OUTPUT
            echo "New Release: $RELEASE_NAME"
          fi

      - name: Setup Directory Structure (First Deploy Only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            if [ ! -d "${{ env.BASE_PATH }}/releases" ]; then
              echo "First deploy, creating directory structure..."
              sudo mkdir -p ${{ env.BASE_PATH }}/releases
              sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.BASE_PATH }}
            else
              echo "Directory structure exists, skipping"
            fi

      - name: Setup Systemd Service (First Deploy Only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            if [ ! -f "/etc/systemd/system/${{ env.SERVICE_NAME }}" ]; then
              echo "First deploy, creating systemd service..."
              sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }} > /dev/null << 'EOF'
            [Unit]
            Description=Remote Inject Server
            After=network.target

            [Service]
            ExecStart=${{ env.BASE_PATH }}/current/${{ env.EXE_NAME }}
            WorkingDirectory=${{ env.BASE_PATH }}/current
            Restart=always
            User=${{ env.SSH_USER }}
            EnvironmentFile=${{ env.BASE_PATH }}/current/.env
            # Custom config directory for i18n and themes (optional)
            # Set CONFIG_DIR secret to enable: e.g., /opt/remote-inject/config
            Environment="CONFIG_DIR=${{ env.BASE_PATH }}/config"

            [Install]
            WantedBy=multi-user.target
            EOF
              sudo systemctl daemon-reload
              sudo systemctl enable ${{ env.SERVICE_NAME }}
            else
              echo "Systemd service exists, skipping"
            fi

      - name: Create Release Directory
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          RELEASE_NAME: ${{ steps.release_info.outputs.release_name }}
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          envs: RELEASE_NAME
          script: |
            mkdir -p ${{ env.BASE_PATH }}/releases/$RELEASE_NAME
            echo "Created release directory: $RELEASE_NAME"

      - name: Copy Binary to Server
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          source: ${{ env.SOURCE_PATH }}
          target: ${{ env.BASE_PATH }}/releases/${{ steps.release_info.outputs.release_name }}
          strip_components: 3

      - name: Deploy & Activate Release
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          RELEASE_NAME: ${{ steps.release_info.outputs.release_name }}
          ENV_CONTENT: ${{ env.ENV_CONTENT }}
          IS_ROLLBACK: ${{ steps.release_info.outputs.is_rollback }}
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          envs: RELEASE_NAME,ENV_CONTENT,IS_ROLLBACK
          script: |
            RELEASE_PATH="${{ env.BASE_PATH }}/releases/$RELEASE_NAME"
            CURRENT_LINK="${{ env.BASE_PATH }}/current"

            # Verify release exists
            if [ ! -d "$RELEASE_PATH" ]; then
              echo "::error::Release not found: $RELEASE_NAME"
              exit 1
            fi

            # Record current version for rollback
            PREVIOUS_RELEASE=""
            if [ -L "$CURRENT_LINK" ]; then
              PREVIOUS_RELEASE=$(readlink -f "$CURRENT_LINK")
              echo "Current version: $(basename $PREVIOUS_RELEASE)"
            fi

            # Write env vars
            if [ "$IS_ROLLBACK" = "false" ] || [ ! -f "$RELEASE_PATH/.env" ]; then
              echo "$ENV_CONTENT" > "$RELEASE_PATH/.env"
              echo ".env file written"
            fi

            # Set executable permission
            chmod +x "$RELEASE_PATH/${{ env.EXE_NAME }}"

            # Update symlink
            ln -sfn "$RELEASE_PATH" "$CURRENT_LINK"
            echo "Symlink updated -> $RELEASE_NAME"

            # Restart service
            sudo systemctl restart ${{ env.SERVICE_NAME }}

            # Health check
            echo "Performing health check..."
            APP_PORT=$(grep -E "^PORT=" "$RELEASE_PATH/.env" | cut -d'=' -f2 | tr -d '"' | tr -d "'" || echo "3700")
            APP_PORT=${APP_PORT:-3700}
            echo "Using port: $APP_PORT"

            HEALTH_OK=false
            for i in $(seq 1 30); do
              if curl -sf "http://localhost:$APP_PORT/health" > /dev/null 2>&1; then
                echo "Health check passed (attempt $i)"
                HEALTH_OK=true
                break
              fi
              echo "  Waiting... ($i/30)"
              sleep 1
            done

            if [ "$HEALTH_OK" = "false" ]; then
              echo "Health check failed after 30 seconds"
              journalctl -u ${{ env.SERVICE_NAME }} -n 20 --no-pager 2>/dev/null || true

              # Rollback
              if [ -n "$PREVIOUS_RELEASE" ] && [ -d "$PREVIOUS_RELEASE" ]; then
                echo "Rolling back to: $(basename $PREVIOUS_RELEASE)"
                ln -sfn "$PREVIOUS_RELEASE" "$CURRENT_LINK"
                sudo systemctl restart ${{ env.SERVICE_NAME }}
                echo "Rolled back successfully"
              fi
              exit 1
            fi

      - name: Cleanup Old Releases
        if: ${{ steps.release_info.outputs.is_rollback == 'false' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            RELEASES_DIR="${{ env.BASE_PATH }}/releases"
            KEEP=${{ env.KEEP_RELEASES }}

            cd "$RELEASES_DIR"
            RELEASE_COUNT=$(ls -1d */ 2>/dev/null | wc -l)

            if [ "$RELEASE_COUNT" -gt "$KEEP" ]; then
              echo "Cleaning old releases (keeping latest $KEEP)..."
              ls -1dt */ | tail -n +$((KEEP + 1)) | while read dir; do
                echo "  Deleting: $dir"
                rm -rf "$dir"
              done
            else
              echo "Current $RELEASE_COUNT releases, no cleanup needed"
            fi

            echo "Current releases:"
            ls -1dt */ | head -n $KEEP
